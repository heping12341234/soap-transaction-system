# SOP架构下的交易系统设计
![image](https://github.com/heping12341234/soap-transaction-system/blob/master/design.png)
## 背景
如果是基于同一个数据库的业务逻辑，可以采用数据的事务来解决，传统的关系型数据基本都支持满足ACID特性的事务。  
如果是不同数据库之间的业务逻辑（数据库物理上存在隔离）可以采用诸如java-JTA的解决方案。  
然后目前大型系统基本都是面向服务的架构，既一个大的系统分为很多小的子系统，彼此之间不暴露数据库，而且通过RPC接口互相连通，甚至各个子系统之间的编程语言都不一致，比如有Java,PHP,Python....这样即使是使用Dubbo这种的服务框架也不能很好的满足。  
虽然如此，但我们仍然能把一些分布式事务的基本思想抽取出来，根据自己的技术栈，组装适合自己的系统。
## 前提知识点
### 接口幂等  
f(f(x)) = f(x)
既，一个接口多次访问总能得到相同的结果。  
具体实现可以用预查询数据库，或者缓存结果来实现。
### 反操作接口
比如，存在一个扣款的接口，就要存在一个返还该扣款的接口。
## 详情
### 子系统内容
每一个子系统都包含自己的数据库，并且包含一套对外提供服务的API接口，协议可以使用http  
外部系统不能直接自己系统的数据库，只能通过开放接口
### 子系统分级、事务处理
子系统分为两级，余额和订单比较重要的采用TCC型事务（Try-Confirm-Cancel）+异步反操作来处理,时效要求低的子系统采用（异步确保+最大尝试）的事务才处理。
